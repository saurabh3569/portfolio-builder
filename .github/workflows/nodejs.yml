name: Deploy Node.js App to Render

on:
  push:
    branches: [main]

jobs:
  install-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server

    steps:
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.17.0"
          cache: "yarn"
          cache-dependency-path: "./server/yarn.lock"

      - name: üì¶ Install dependencies
        run: yarn install --frozen-lockfile

      # Debug step to verify secret is available (will show length but not value)
      - name: üîç Verify Render Hook Secret
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "::warning::RENDER_DEPLOY_HOOK secret appears to be empty"
            echo "Secret length: 0"
          else
            echo "Secret length: ${#RENDER_DEPLOY_HOOK}"
          fi
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}

      # Main deployment trigger
      - name: üöÄ Trigger Render Deploy
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "::error::Render deploy hook URL is empty!"
            exit 1
          fi

          echo "Triggering Render deployment..."
          curl -X POST \
            -H "Accept: application/json" \
            "$RENDER_DEPLOY_HOOK"

          echo "Deployment trigger completed."
